<!DOCTYPE html>
<html lang="es">
<head>
ย <meta charset="UTF-8">
ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย <title>Calendario de Comidas</title>
ย <style>
ย ย body {
ย ย ย font-family: 'Inter', sans-serif;
ย ย ย display: flex;
ย ย ย flex-direction: column;
ย ย ย align-items: center;
ย ย ย padding: 20px;
ย ย ย background-color: #f4f4f9;
ย ย }
ย ย h1, h2 {
ย ย ย color: #333;
ย ย ย text-align: center;
ย ย }
ย ย .buttons-container {
ย ย ย display: flex;
ย ย ย flex-wrap: wrap;
ย ย ย justify-content: center;
ย ย ย margin-bottom: 20px;
ย ย }
ย ย button {
ย ย ย background-color: #4285f4;
ย ย ย color: white;
ย ย ย border: none;
ย ย ย padding: 12px 24px;
ย ย ย text-align: center;
ย ย ย text-decoration: none;
ย ย ย font-size: 16px;
ย ย ย margin: 5px;
ย ย ย cursor: pointer;
ย ย ย border-radius: 8px;
ย ย ย box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
ย ย ย transition: background-color 0.3s ease;
ย ย }
ย ย button:hover {
ย ย ย background-color: #357ae8;
ย ย }
ย ย #save-button {
ย ย ย background-color: #34a853;
ย ย }
ย ย #save-button:hover {
ย ย ย background-color: #2b8c45;
ย ย }
ย ย .container {
ย ย ย background-color: white;
ย ย ย padding: 20px;
ย ย ย border-radius: 10px;
ย ย ย box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
ย ย ย max-width: 95%;
ย ย ย overflow-x: auto;
ย ย }
ย ย table {
ย ย ย width: 100%;
ย ย ย border-collapse: collapse;
ย ย ย margin-top: 20px;
ย ย }
ย ย th, td {
ย ย ย /* Bordes mรกs visibles */
ย ย ย border: 3px solid #666;
ย ย ย padding: 12px;
ย ย ย text-align: left;
ย ย ย white-space: nowrap;
ย ย ย min-width: 100px;
ย ย }
ย ย th {
ย ย ย background-color: #f0f0f0;
ย ย ย color: #555;
ย ย ย font-weight: bold;
ย ย }
ย ย /* Estilos para la celda activa */
ย ย td[contenteditable="true"]:focus,
ย ย .selected-cell {
ย ย ย outline: none;
ย ย ย border-color: #3b82f6;
ย ย ย box-shadow: 0 0 8px rgba(59, 130, 246, 0.7);
ย ย }
ย ย #status-message {
ย ย ย margin-top: 10px;
ย ย ย font-style: italic;
ย ย ย color: #777;
ย ย ย text-align: center;
ย ย }
ย </style>
ย <script src="https://apis.google.com/js/api.js"></script>
ย <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
ย <h1>Calendario de Comidas</h1>

ย <div class="buttons-container">
ย ย <button id="login">Iniciar sesiรณn con Google</button>
ย ย <button id="logout" style="display:none">Cerrar sesiรณn</button>
ย ย <button id="save-button" style="display:none">Guardar Cambios</button>
ย </div>

ย <div id="contenido" class="container" style="display:none">
ย ย <h2>Datos del mes</h2>
ย ย <div id="resultado"></div>
ย ย <div id="status-message"></div>
ย </div>

ย <script>
ย ย const CLIENT_ID = "688826321509-sb3n6gt3mpusmbvorsgdnketbbb1a25b.apps.googleusercontent.com";
ย ย const API_KEY = "AIzaSyC-foiUdpoGY9DY0CpG9c4EzMtqpCBoK5w";
ย ย const SPREADSHEET_ID = "11_kq2qaKl2f2awWh0ea1IUelHmqUKDyyU6apbZvWbyo";
ย ย const RANGE = "Setembre25!A1:D91";
ย ย const SCOPE = "https://www.googleapis.com/auth/spreadsheets";

ย ย let token = null;

ย ย gapi.load("client", async () => {
ย ย ย console.log("โ gapi.client cargado");
ย ย ย await gapi.client.init({
ย ย ย ย apiKey: API_KEY,
ย ย ย ย discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
ย ย ย });
ย ย ย console.log("โ gapi.client inicializado");
ย ย });

ย ย function login() {
ย ย ย console.log("๐ Iniciando login...");
ย ย ย google.accounts.oauth2.initTokenClient({
ย ย ย ย client_id: CLIENT_ID,
ย ย ย ย scope: SCOPE,
ย ย ย ย callback: (resp) => {
ย ย ย ย ย console.log("โ Token recibido:", resp);
ย ย ย ย ย token = resp.access_token;
ย ย ย ย ย gapi.client.setToken({ access_token: token });

ย ย ย ย ย document.getElementById("login").style.display = "none";
ย ย ย ย ย document.getElementById("logout").style.display = "block";
ย ย ย ย ย document.getElementById("save-button").style.display = "block";
ย ย ย ย ย document.getElementById("contenido").style.display = "block";

ย ย ย ย ย leerDatos();
ย ย ย ย }
ย ย ย }).requestAccessToken();
ย ย }

ย ย function logout() {
ย ย ย console.log("๐ช Logout");
ย ย ย token = null;
ย ย ย document.getElementById("login").style.display = "block";
ย ย ย document.getElementById("logout").style.display = "none";
ย ย ย document.getElementById("save-button").style.display = "none";
ย ย ย document.getElementById("contenido").style.display = "none";
ย ย ย document.getElementById("resultado").innerHTML = "";
ย ย ย document.getElementById("status-message").innerHTML = "";
ย ย }

ย ย async function leerDatos() {
ย ย ย document.getElementById("status-message").innerHTML = "Cargando datos...";
ย ย ย console.log("๐ Leyendo datos de la hoja...");
ย ย ย try {
ย ย ย ย const response = await gapi.client.sheets.spreadsheets.values.get({
ย ย ย ย ย spreadsheetId: SPREADSHEET_ID,
ย ย ย ย ย range: RANGE
ย ย ย ย });
ย ย ย ย console.log("โ Respuesta de Sheets:", response);

ย ย ย ย const filas = response.result.values || [];
ย ย ย ย if (filas.length === 0) {
ย ย ย ย ย document.getElementById("resultado").innerHTML = "<p>No hay datos</p>";
ย ย ย ย ย document.getElementById("status-message").innerHTML = "";
ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย let tabla = "<table><thead><tr>";
ย ย ย ย const encabezados = filas[0];
ย ย ย ย encabezados.forEach(encabezado => {
ย ย ย ย ย tabla += `<th>${encabezado || ""}</th>`;
ย ย ย ย });
ย ย ย ย tabla += "</tr></thead><tbody>";

ย ย ย ย for (let i = 1; i < filas.length; i++) {
ย ย ย ย ย const fila = filas[i];
ย ย ย ย ย tabla += "<tr>";
ย ย ย ย ย fila.forEach((celda, j) => {
ย ย ย ย ย ย const editable = (j > 0) ? 'contenteditable="true"' : '';
ย ย ย ย ย ย tabla += `<td ${editable}>${celda || ""}</td>`;
ย ย ย ย ย });
ย ย ย ย ย tabla += "</tr>";
ย ย ย ย }

ย ย ย ย tabla += "</tbody></table>";
ย ย ย ย document.getElementById("resultado").innerHTML = tabla;
ย ย ย ย document.getElementById("status-message").innerHTML = "Datos cargados. Haz clic o usa la tecla 'Tab' para editar.";
ย ย ย ย 
ย ย ย ย // Listener para el resaltado de celdas al hacer clic
ย ย ย ย const tableElement = document.querySelector("#resultado table");
ย ย ย ย tableElement.addEventListener('click', (event) => {
ย ย ย ย ย const target = event.target;
ย ย ย ย ย if (target.tagName === 'TD' || target.tagName === 'TH') {
ย ย ย ย ย ย const previousSelected = document.querySelector('.selected-cell');
ย ย ย ย ย ย if (previousSelected) {
ย ย ย ย ย ย ย previousSelected.classList.remove('selected-cell');
ย ย ย ย ย ย }
ย ย ย ย ย ย target.classList.add('selected-cell');
ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // CAMBIO: Nuevo listener para la navegaciรณn con la tecla Tab
ย ย ย ย tableElement.addEventListener('keydown', (event) => {
ย ย ย ย ย if (event.key === 'Tab') {
ย ย ย ย ย ย event.preventDefault();
ย ย ย ย ย ย const celdasEditables = Array.from(document.querySelectorAll('td[contenteditable="true"]'));
ย ย ย ย ย ย const celdaActual = document.activeElement;
ย ย ย ย ย ย const currentIndex = celdasEditables.indexOf(celdaActual);

ย ย ย ย ย ย let nextIndex;
ย ย ย ย ย ย if (event.shiftKey) {
ย ย ย ย ย ย ย // Shift+Tab (navegar hacia atrรกs)
ย ย ย ย ย ย ย nextIndex = (currentIndex > 0) ? currentIndex - 1 : celdasEditables.length - 1;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย // Tab (navegar hacia adelante)
ย ย ย ย ย ย ย nextIndex = (currentIndex < celdasEditables.length - 1) ? currentIndex + 1 : 0;
ย ย ย ย ย ย }

ย ย ย ย ย ย celdasEditables[nextIndex].focus();

ย ย ย ย ย ย // Quitar el resaltado de la celda anterior y aรฑadirlo a la nueva
ย ย ย ย ย ย const previousSelected = document.querySelector('.selected-cell');
ย ย ย ย ย ย if (previousSelected) {
ย ย ย ย ย ย ย previousSelected.classList.remove('selected-cell');
ย ย ย ย ย ย }
ย ย ย ย ย ย celdasEditables[nextIndex].classList.add('selected-cell');
ย ย ย ย ย }
ย ย ย ย });

ย ย ย } catch (e) {
ย ย ย ย console.error("โ Error leyendo datos:", e);
ย ย ย ย document.getElementById("status-message").innerHTML = "<p>Error al leer datos. Revisa la consola para mรกs detalles.</p>";
ย ย ย }
ย ย }

ย ย async function guardarDatos() {
ย ย ย document.getElementById("status-message").innerHTML = "Guardando cambios...";
ย ย ย console.log("๐พ Guardando datos en la hoja...");

ย ย ย try {
ย ย ย ย const tabla = document.querySelector("#resultado table");
ย ย ย ย const filas = tabla.querySelectorAll("tbody tr");
ย ย ย ย const nuevosDatos = [];

ย ย ย ย filas.forEach(fila => {
ย ย ย ย ย const celdas = fila.querySelectorAll("td");
ย ย ย ย ย const nuevaFila = [];
ย ย ย ย ย celdas.forEach(celda => {
ย ย ย ย ย ย nuevaFila.push(celda.innerText);
ย ย ย ย ย });
ย ย ย ย ย nuevosDatos.push(nuevaFila);
ย ย ย ย });

ย ย ย ย const response = await gapi.client.sheets.spreadsheets.values.update({
ย ย ย ย ย spreadsheetId: SPREADSHEET_ID,
ย ย ย ย ย range: `Setembre25!A2:D${nuevosDatos.length + 1}`,
ย ย ย ย ย valueInputOption: "USER_ENTERED",
ย ย ย ย ย resource: {
ย ย ย ย ย ย values: nuevosDatos
ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย console.log("โ Datos guardados:", response);
ย ย ย ย document.getElementById("status-message").innerHTML = "โ Cambios guardados con รฉxito.";
ย ย ย } catch (e) {
ย ย ย ย console.error("โ Error guardando datos:", e);
ย ย ย ย document.getElementById("status-message").innerHTML = "<p>Error al guardar. Revisa la consola para mรกs detalles.</p>";
ย ย ย }
ย ย }

ย ย document.getElementById("login").onclick = login;
ย ย document.getElementById("logout").onclick = logout;
ย ย document.getElementById("save-button").onclick = guardarDatos;
ย </script>
</body>
</html>


